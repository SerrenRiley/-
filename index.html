<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>任务卡 · 日常轻张力 v0.3</title>
<style>
:root{
  --bg:#0b0f17;
  --panel:#0f1726;
  --panel2:#101b2d;
  --stroke:rgba(255,255,255,.10);
  --stroke2:rgba(255,255,255,.14);
  --text:#e8eefc;
  --muted:#aab6d6;
  --accent:#6aa9ff;
  --good:#61d095;
  --bad:#ff6a6a;
  --shadow: 0 10px 35px rgba(0,0,0,.35);
}

*{ box-sizing:border-box; }
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
  color:var(--text);
  background: radial-gradient(1200px 800px at 20% 5%, #152547 0%, var(--bg) 55%);
}

.app{ max-width: 1180px; margin:0 auto; padding: 18px; }

.topbar{
  display:flex;
  gap:14px;
  align-items:center;
  justify-content:space-between;
  padding: 14px 14px;
  border: 1px solid var(--stroke);
  background: rgba(15,23,38,.72);
  border-radius: 16px;
  box-shadow: var(--shadow);
}

.brand{ min-width: 220px; }
.title{ font-size: 16px; font-weight: 800; letter-spacing:.4px; }
.subtitle{ margin-top:4px; font-size: 12px; color: var(--muted); }

.hud{
  display:flex; flex-wrap:wrap; gap:8px;
  align-items:center; justify-content:center; flex:1;
}
.pill{
  padding: 7px 10px;
  border-radius: 999px;
  border: 1px solid var(--stroke);
  background: rgba(255,255,255,.05);
  font-size: 12px;
  color: var(--muted);
}
.pill span{ color: var(--text); font-weight: 700; }
.pill.subtle{ opacity:.85; }

.headerActions{ display:flex; gap:8px; }
.btn{
  border: 1px solid var(--stroke2);
  background: rgba(255,255,255,.05);
  color: var(--text);
  padding: 9px 10px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 12px;
}
.btn.primary{
  background: linear-gradient(180deg, rgba(106,169,255,.22), rgba(106,169,255,.08));
  border-color: rgba(106,169,255,.35);
}
.btn.danger{
  background: linear-gradient(180deg, rgba(255,106,106,.18), rgba(255,106,106,.05));
  border-color: rgba(255,106,106,.30);
}
.btn:active{ transform: translateY(1px); }

.layout{
  margin-top: 14px;
  display:grid;
  grid-template-columns: 1.35fr 0.9fr 0.75fr;
  gap: 12px;
}

.panel{
  border: 1px solid var(--stroke);
  background: rgba(15,23,38,.62);
  border-radius: 16px;
  box-shadow: var(--shadow);
  padding: 12px;
  min-height: 120px;
}

.panelTitle{
  font-size: 12px;
  color: var(--muted);
  letter-spacing:.6px;
  text-transform: uppercase;
  margin-bottom: 10px;
}

.logPanel{ display:flex; flex-direction:column; gap:10px; }
.log{
  height: 320px;
  overflow:auto;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(0,0,0,.25);
  border-radius: 14px;
  padding: 10px;
  font-size: 12.5px;
  line-height: 1.55;
}
.log .line{ color: rgba(232,238,252,.86); margin: 6px 0; }
.log .sys{ color: rgba(170,182,214,.92); }
.log .evt{ color: rgba(232,238,252,.95); }
.log .hint{ color: rgba(106,169,255,.92); }
.log .warn{ color: rgba(255,106,106,.92); }

.eventBox{
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(16,27,45,.62);
  border-radius: 14px;
  padding: 10px;
  min-height: 140px;
}
.eventText{
  font-size: 13px;
  color: rgba(232,238,252,.95);
  line-height: 1.6;
  white-space: pre-wrap;
}
.choices{ margin-top: 10px; display:flex; flex-direction:column; gap:8px; }
.choiceBtn{
  text-align:left;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.05);
  color: var(--text);
  padding: 10px 10px;
  border-radius: 12px;
  cursor:pointer;
  font-size: 12.5px;
  line-height: 1.4;
}
.choiceBtn:disabled{
  opacity: .45;
  cursor:not-allowed;
}
.choiceBtn.primary{
  border-color: rgba(106,169,255,.35);
  background: rgba(106,169,255,.12);
}
.choiceBtn:active{ transform: translateY(1px); }

.actionsPanel .cards{ display:grid; grid-template-columns: 1fr; gap: 10px; }
.card{
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  border-radius: 14px;
  padding: 12px;
  cursor:pointer;
  text-align:left;
}
.card.soft{
  border-color: rgba(170,182,214,.22);
  background: rgba(170,182,214,.06);
}
.cardTitle{ font-weight: 800; letter-spacing:.3px; }
.cardDesc{ margin-top:6px; color: var(--muted); font-size: 12px; line-height:1.5; }
.cardMeta{ margin-top:10px; font-size: 11.5px; color: rgba(232,238,252,.70); }
.card:disabled{ opacity:.45; cursor:not-allowed; }
.card:active{ transform: translateY(1px); }

.tips{
  margin-top: 12px;
  border-radius: 14px;
  border: 1px dashed rgba(255,255,255,.18);
  padding: 10px;
  color: var(--muted);
  font-size: 12px;
  line-height: 1.6;
}
.tipTitle{ color: rgba(232,238,252,.86); font-weight: 700; margin-bottom: 6px; }

.sidePanel .list{ display:flex; flex-direction:column; gap:8px; }
.row{ display:flex; justify-content:space-between; color: rgba(232,238,252,.90); font-size: 12.5px; }
.row.subtle{ color: var(--muted); }
.divider{ height: 1px; background: rgba(255,255,255,.08); margin: 12px 0; }

.footer{
  margin-top: 12px;
  font-size: 12px;
  color: var(--muted);
  opacity: .9;
  padding: 6px 2px;
}

@media (max-width: 980px){
  .layout{ grid-template-columns: 1fr; }
  .log{ height: 260px; }
  .topbar{ flex-direction:column; align-items:stretch; }
  .headerActions{ justify-content:flex-end; }
  .hud{ justify-content:flex-start; }
}
</style>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b1220">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="任务卡 v0.3">
</head>
<body>
<div class="app">
<header class="topbar">
  <div class="brand">
    <div class="title">任务卡 · 日常轻张力 v0.3</div>
    <div class="subtitle">纯前端 / 无第三方库 · 每天必触发一次随机事件</div>
  </div>
  <div class="hud">
    <div class="pill">DAY <span id="day">1</span></div>
    <div class="pill">信任 <span id="trust">5</span></div>
    <div class="pill">体力 <span id="stamina">6</span></div>
    <div class="pill">张力 <span id="chemistry">0</span></div>
    <div class="pill subtle">物品 <span id="itemsSummary">-</span></div>
  </div>
  <div class="headerActions">
    <button class="btn primary" id="btnNew">新开档</button>
    <button class="btn" id="btnSave">手动保存</button>
    <button class="btn danger" id="btnReset">清空存档</button>
  </div>
</header>
<main class="layout">
  <section class="panel logPanel">
    <div class="panelTitle">终端日志</div>
    <div class="log" id="log"></div>
    <div class="eventBox">
      <div class="eventText" id="eventText"></div>
      <div class="choices" id="choices"></div>
    </div>
  </section>
  <section class="panel actionsPanel">
    <div class="panelTitle">日常入口</div>
    <div class="cards">
      <button class="card" id="actDaily">
        <div class="cardTitle">日常主线</div>
        <div class="cardDesc">走进值班室、走廊与食堂的小事，推动关系日常化</div>
        <div class="cardMeta">轻松节奏</div>
      </button>
      <button class="card" id="actTurbulence">
        <div class="cardTitle">小波澜</div>
        <div class="cardDesc">设备故障、临时换班、雨夜门口等小插曲</div>
        <div class="cardMeta">轻张力</div>
      </button>
      <button class="card soft" id="actNextDay">
        <div class="cardTitle">进入下一天</div>
        <div class="cardDesc">写下当日总结，体力恢复</div>
        <div class="cardMeta">DAY +1</div>
      </button>
    </div>
    <div class="tips">
      <div class="tipTitle">今日节奏</div>
      <div class="tipText" id="tipText">每天会先触发一次随机事件，再进入日常主线或小波澜。</div>
    </div>
  </section>
  <aside class="panel sidePanel">
    <div class="panelTitle">随身物品</div>
    <div class="list">
      <div class="row"><span>热茶包</span><span id="itemTea">1</span></div>
      <div class="row"><span>小零食</span><span id="itemSnack">2</span></div>
      <div class="row"><span>薄毯</span><span id="itemBlanket">1</span></div>
      <div class="row"><span>工具盒</span><span id="itemToolkit">0</span></div>
      <div class="row"><span>门卡</span><span id="itemKeycard">0</span></div>
    </div>
    <div class="divider"></div>
    <div class="panelTitle">状态提示</div>
    <div class="list">
      <div class="row"><span>男主</span><span id="maleName">沈砚</span></div>
      <div class="row subtle"><span>当前场景</span><span id="sceneTitle">-</span></div>
      <div class="row subtle"><span>随机事件</span><span id="dailyEventCount">-</span></div>
    </div>
  </aside>
</main>
<footer class="footer">
  <span>Demo：你可以直接在事件池里加剧情对象，不需要改引擎逻辑。</span>
</footer>
</div>
<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const el = {
    day: $("day"),
    trust: $("trust"),
    stamina: $("stamina"),
    chemistry: $("chemistry"),
    itemsSummary: $("itemsSummary"),
    log: $("log"),
    eventText: $("eventText"),
    choices: $("choices"),
    itemTea: $("itemTea"),
    itemSnack: $("itemSnack"),
    itemBlanket: $("itemBlanket"),
    itemToolkit: $("itemToolkit"),
    itemKeycard: $("itemKeycard"),
    sceneTitle: $("sceneTitle"),
    dailyEventCount: $("dailyEventCount"),
    tipText: $("tipText"),
    btnNew: $("btnNew"),
    btnSave: $("btnSave"),
    btnReset: $("btnReset"),
    actDaily: $("actDaily"),
    actTurbulence: $("actTurbulence"),
    actNextDay: $("actNextDay")
  };

  const SAVE_KEY = "taskcard_v03";

  function nowTime(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${hh}:${mm}`;
  }

  function clamp(n, min, max){
    return Math.max(min, Math.min(max, n));
  }

  function defaultState(){
    return {
      day: 1,
      dayEventDone: false,
      daySeed: null,
      daySummary: "",
      trust: 5,
      stamina: 6,
      chemistry: 0,
      items: {
        tea: 1,
        snack: 2,
        blanket: 1,
        toolkit: 0,
        keycard: 0
      },
      flags: {
        lastSeen: {}
      },
      recentDaily: [],
      recentDailyMain: [],
      recentTurbulence: [],
      log: [],
      currentScene: "dayStart"
    };
  }

  function loadState(){
    try{
      const raw = window.localStorage.getItem(SAVE_KEY);
      if (!raw) return null;
      const saved = JSON.parse(raw);
      const base = defaultState();
      return {
        ...base,
        ...saved,
        items: { ...base.items, ...(saved.items || {}) },
        flags: { ...base.flags, ...(saved.flags || {}) },
        recentDaily: Array.isArray(saved.recentDaily) ? saved.recentDaily : [],
        recentDailyMain: Array.isArray(saved.recentDailyMain) ? saved.recentDailyMain : [],
        recentTurbulence: Array.isArray(saved.recentTurbulence) ? saved.recentTurbulence : [],
        log: Array.isArray(saved.log) ? saved.log : [],
      };
    }catch(e){
      return null;
    }
  }

  function saveState(){
    try{
      window.localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    }catch(e){}
  }

  function addLine(kind, text){
    const line = { t: nowTime(), kind, text };
    state.log.push(line);
    if (state.log.length > 280) state.log = state.log.slice(-280);
    appendLine(line);
  }

  function appendLine(l){
    const div = document.createElement("div");
    div.className = `line ${l.kind}`;
    div.textContent = `[${l.t}] ${l.text}`;
    el.log.appendChild(div);
    el.log.scrollTop = el.log.scrollHeight;
  }

  function renderLog(){
    el.log.innerHTML = "";
    state.log.forEach(appendLine);
    el.log.scrollTop = el.log.scrollHeight;
  }

  function addSys(text){ addLine("sys", text); }
  function addEvt(text){ addLine("evt", text); }
  function addHint(text){ addLine("hint", text); }
  function addWarn(text){ addLine("warn", text); }

  function itemSummary(){
    const list = [];
    if (state.items.tea) list.push(`茶包x${state.items.tea}`);
    if (state.items.snack) list.push(`零食x${state.items.snack}`);
    if (state.items.blanket) list.push(`薄毯x${state.items.blanket}`);
    if (state.items.toolkit) list.push(`工具盒x${state.items.toolkit}`);
    if (state.items.keycard) list.push(`门卡x${state.items.keycard}`);
    return list.length ? list.join("、") : "无";
  }

  function renderHUD(){
    el.day.textContent = String(state.day);
    el.trust.textContent = String(state.trust);
    el.stamina.textContent = String(state.stamina);
    el.chemistry.textContent = String(state.chemistry);
    el.itemsSummary.textContent = itemSummary();

    el.itemTea.textContent = String(state.items.tea);
    el.itemSnack.textContent = String(state.items.snack);
    el.itemBlanket.textContent = String(state.items.blanket);
    el.itemToolkit.textContent = String(state.items.toolkit);
    el.itemKeycard.textContent = String(state.items.keycard);

    el.dailyEventCount.textContent = `${state.dayEventDone ? "已触发" : "未触发"}`;
  }

  function applyEffects(effects){
    if (!effects) return { chemistryDelta: 0 };
    let chemistryDelta = 0;
    if (effects.trust) state.trust = clamp(state.trust + effects.trust, 0, 100);
    if (effects.stamina) state.stamina = clamp(state.stamina + effects.stamina, 0, 100);
    if (effects.chemistry){
      state.chemistry = clamp(state.chemistry + effects.chemistry, 0, 100);
      chemistryDelta = effects.chemistry;
    }
    if (effects.items){
      Object.keys(effects.items).forEach((key) => {
        const cur = Number.isFinite(state.items[key]) ? state.items[key] : 0;
        state.items[key] = clamp(cur + effects.items[key], 0, 99);
      });
    }
    if (effects.flags){
      Object.keys(effects.flags).forEach((key) => {
        state.flags[key] = effects.flags[key];
      });
    }
    return { chemistryDelta };
  }

  function formatEffectLine(effects){
    if (!effects) return "";
    const parts = [];
    if (effects.trust) parts.push(`信任${effects.trust > 0 ? "+" : ""}${effects.trust}`);
    if (effects.stamina) parts.push(`体力${effects.stamina > 0 ? "+" : ""}${effects.stamina}`);
    if (effects.chemistry) parts.push(`张力${effects.chemistry > 0 ? "+" : ""}${effects.chemistry}`);
    if (effects.items){
      Object.keys(effects.items).forEach((key) => {
        const label = itemLabels[key] || key;
        const val = effects.items[key];
        parts.push(`${label}${val > 0 ? "+" : ""}${val}`);
      });
    }
    return parts.length ? `（${parts.join(" / ")}）` : "";
  }

  const itemLabels = {
    tea: "茶包",
    snack: "零食",
    blanket: "薄毯",
    toolkit: "工具盒",
    keycard: "门卡"
  };

  function setScene(scene){
    state.currentScene = scene.id;
    el.eventText.textContent = `${scene.title}\n${scene.text}`;
    el.sceneTitle.textContent = scene.title;
    el.choices.innerHTML = "";

    const choices = scene.choices || [];
    choices.forEach((choice, idx) => {
      const btn = document.createElement("button");
      btn.className = "choiceBtn" + (idx === 0 ? " primary" : "");
      btn.textContent = choice.label;
      const can = typeof choice.requires === "function" ? !!choice.requires(state) : true;
      btn.disabled = !can;
      btn.addEventListener("click", () => {
        if (btn.disabled) return;
        const effectLine = formatEffectLine(choice.effects);
        addHint(`选择：${choice.label}${effectLine}`);
        const { chemistryDelta } = applyEffects(choice.effects);
        if (chemistryDelta){
          addEvt(`张力波动：${chemistryDelta > 0 ? "+" : ""}${chemistryDelta}`);
        }
        if (choice.log){
          addEvt(choice.log);
        }
        if (choice.after){
          choice.after(state);
        }
        if (scene.type === "dailyEvent"){
          state.dayEventDone = true;
          state.flags.lastSeen[scene.id] = state.day;
          state.recentDaily.push(scene.id);
          if (state.recentDaily.length > 8) state.recentDaily = state.recentDaily.slice(-8);
          enterScene("hub");
          return;
        }
        const defaultNext = (scene.type === "dailyMain" || scene.type === "turbulence") ? "hub" : null;
        const nextScene = choice.next || defaultNext;
        if (nextScene){
          enterScene(nextScene);
        } else {
          renderHUD();
          saveState();
        }
      });
      el.choices.appendChild(btn);
    });
    renderHUD();
    saveState();
  }

  function enterScene(id){
    const scene = sceneMap[id];
    if (!scene) return;
    setScene(scene);
  }

  function pickFromPool(pool, recentKey){
    const recent = state[recentKey] || [];
    const candidates = pool.filter((scene) => {
      if (typeof scene.requires === "function" && !scene.requires(state)) return false;
      const lastSeen = state.flags.lastSeen[scene.id];
      if (lastSeen && (state.day - lastSeen) < 7) return false;
      if (recent.includes(scene.id)) return false;
      return true;
    });
    const list = candidates.length ? candidates : pool;
    const chosen = list[Math.floor(Math.random() * list.length)];
    state.flags.lastSeen[chosen.id] = state.day;
    state[recentKey] = [...recent, chosen.id].slice(-6);
    return chosen;
  }

  function pickDailyEvent(){
    const candidates = dailyEvents.filter((scene) => {
      if (typeof scene.requires === "function" && !scene.requires(state)) return false;
      const lastSeen = state.flags.lastSeen[scene.id];
      if (lastSeen && (state.day - lastSeen) < 7) return false;
      if (state.recentDaily.includes(scene.id)) return false;
      return true;
    });
    const list = candidates.length ? candidates : dailyEvents;
    const chosen = list[Math.floor(Math.random() * list.length)];
    return chosen;
  }

  function triggerDailyEvent(){
    const eventScene = pickDailyEvent();
    addEvt(`每日随机事件：${eventScene.title}`);
    setScene(eventScene);
  }

  function startDayFlow(){
    if (!state.dayEventDone){
      triggerDailyEvent();
    } else {
      enterScene("hub");
    }
  }

  function endDay(){
    const summary = generateDaySummary();
    state.daySummary = summary;
    addSys(`第 ${state.day} 天结束：${summary}`);
    state.day += 1;
    state.dayEventDone = false;
    state.stamina = clamp(state.stamina + 3, 0, 100);
    state.daySeed = `${state.day}-${Math.random().toString(16).slice(2, 6)}`;
    enterScene("dayStart");
  }

  function generateDaySummary(){
    if (state.chemistry >= 20 && state.trust >= 20) return "你们的默契越来越像一种默认的站队。";
    if (state.chemistry >= 20) return "暧昧的火花被你小心地揣在口袋里。";
    if (state.trust >= 20) return "你们的合作逐渐稳定，像无声的靠近。";
    if (state.stamina <= 3) return "你把疲惫放在门口，先睡一觉再说。";
    return "日常起伏不大，但你记得他的眼神。";
  }

  const dailyEvents = [
    {
      id: "ev_light_01",
      type: "dailyEvent",
      category: "轻松日常",
      title: "值班室的风扇",
      text: "值班室的风扇转得慢，你和沈砚一人一边试着调角度。",
      choices: [
        { label: "让他调，你去拿冰水", effects: { trust: 1, chemistry: 1, items: { tea: 1 } }, log: "你把冰水塞到他手里，他笑了一下。" },
        { label: "你靠近观察角度", effects: { stamina: -1, chemistry: 2 }, log: "你肩膀几乎碰到他，他故意不退。" }
      ]
    },
    {
      id: "ev_light_02",
      type: "dailyEvent",
      category: "轻松日常",
      title: "走廊擦肩",
      text: "走廊太窄，你和他几乎同时转弯。",
      choices: [
        { label: "故意不让路", effects: { chemistry: 2 }, log: "你们停在同一条线，谁都没先退。" },
        { label: "轻声说抱歉", effects: { trust: 1, chemistry: 1 }, log: "他看了你一秒，抬手替你挡住人流。" }
      ]
    },
    {
      id: "ev_light_03",
      type: "dailyEvent",
      category: "轻松日常",
      title: "食堂的汤",
      text: "食堂只剩一份热汤，他把碗推到你面前。",
      choices: [
        { label: "接过，跟他说谢谢", effects: { trust: 2, chemistry: 1 }, log: "他嘴角动了动，说不客气。" },
        { label: "坚持平分", effects: { chemistry: 2 }, log: "你们拿着同一把勺子，谁都没先放。" }
      ]
    },
    {
      id: "ev_light_04",
      type: "dailyEvent",
      category: "轻松日常",
      title: "训练房的绑带",
      text: "你系绑带时有点松，他伸手帮你拉紧。",
      choices: [
        { label: "说他手太重", effects: { chemistry: 1, trust: 1 }, log: "他挑眉，说你也没躲。" },
        { label: "不动，让他系好", effects: { chemistry: 2, stamina: 1 }, log: "他靠得很近，但动作很稳。" }
      ]
    },
    {
      id: "ev_light_05",
      type: "dailyEvent",
      category: "轻松日常",
      title: "装备间的钥匙",
      text: "装备间钥匙卡住了，他从你背后伸手。",
      choices: [
        { label: "稳住他的手", effects: { chemistry: 2 }, log: "你掌心碰到他的手背。" },
        { label: "笑他太急", effects: { chemistry: 1, trust: 1 }, log: "他低声笑了一下。" }
      ]
    },
    {
      id: "ev_light_06",
      type: "dailyEvent",
      category: "轻松日常",
      title: "医务室的药味",
      text: "医务室里药味重，你们靠在门口透气。",
      choices: [
        { label: "问他要不要出去走走", effects: { trust: 1, chemistry: 1 }, log: "他点头，说跟你。" },
        { label: "调侃他怕苦", effects: { chemistry: 2 }, log: "他靠近，回你一句：谁说我怕。" }
      ]
    },
    {
      id: "ev_light_07",
      type: "dailyEvent",
      category: "轻松日常",
      title: "屋顶的风",
      text: "屋顶风大，他把外套搭在你肩上。",
      choices: [
        { label: "抬头看他", effects: { chemistry: 2 }, log: "他收回视线的速度比风还快。" },
        { label: "把外套递回去", effects: { trust: 2, chemistry: 1 }, log: "他没接，只说先穿着。" }
      ]
    },
    {
      id: "ev_light_08",
      type: "dailyEvent",
      category: "轻松日常",
      title: "雨天门口",
      text: "雨声淹没了脚步声，你们一起站在门口。",
      choices: [
        { label: "共用一把伞", effects: { chemistry: 2, stamina: 1 }, log: "伞沿压得很低，你们靠得更近。" },
        { label: "把伞塞给他", effects: { trust: 1, chemistry: 1 }, log: "他没推回去，只说晚点还你。" }
      ]
    },
    {
      id: "ev_light_09",
      type: "dailyEvent",
      category: "轻松日常",
      title: "深夜泡茶",
      text: "夜里你泡了茶，他路过时停了一下。",
      choices: [
        { label: "请他喝一口", effects: { chemistry: 1, trust: 1, items: { tea: -1 } }, log: "他接过杯子，说味道刚好。" },
        { label: "装作没注意", effects: { trust: 1 }, log: "他还是轻声说了句晚安。" }
      ]
    },
    {
      id: "ev_light_10",
      type: "dailyEvent",
      category: "轻松日常",
      title: "走廊灯泡",
      text: "走廊灯泡坏了，他让你把手电靠近。",
      choices: [
        { label: "把光照向他的脸", effects: { chemistry: 1 }, log: "他眯了眯眼，仍然没退。" },
        { label: "让他踩凳子", effects: { trust: 1, stamina: -1 }, log: "他站稳后提醒你别抖。" }
      ]
    },
    {
      id: "ev_light_11",
      type: "dailyEvent",
      category: "轻松日常",
      title: "食堂队伍",
      text: "排队时他站在你身后，轻声问你要不要换位。",
      choices: [
        { label: "靠后，让他挡人", effects: { chemistry: 2 }, log: "你贴近他的背影，他没说话。" },
        { label: "拒绝他好意", effects: { trust: 1, chemistry: -1 }, log: "他也没勉强，只是点点头。" }
      ]
    },
    {
      id: "ev_light_12",
      type: "dailyEvent",
      category: "轻松日常",
      title: "训练房的水壶",
      text: "水壶没盖好，他拧紧后递给你。",
      choices: [
        { label: "道谢并递回一半", effects: { trust: 1, chemistry: 1 }, log: "你们各喝一口。" },
        { label: "调侃他管太多", effects: { chemistry: 2 }, log: "他笑着说：那你别让我管。" }
      ]
    },
    {
      id: "ev_tension_01",
      type: "dailyEvent",
      category: "高张力互动",
      title: "值班表对峙",
      text: "值班表被改动，他站在你面前问是谁动的。",
      choices: [
        { label: "顶回去：你也没问我", effects: { chemistry: 2, trust: -1 }, log: "他挑眉，嘴角却松了。" },
        { label: "低声解释原因", effects: { trust: 2, chemistry: 1 }, log: "他看了你一会儿，说下次告诉他。" }
      ]
    },
    {
      id: "ev_tension_02",
      type: "dailyEvent",
      category: "高张力互动",
      title: "走廊壁咚",
      text: "你转身时差点撞上他，他抬手撑在你身侧。",
      choices: [
        { label: "不退，盯回去", effects: { chemistry: 3 }, log: "他低声笑，说你胆子不小。" },
        { label: "轻推他一下", effects: { chemistry: 1, trust: 1 }, log: "他顺势退开，但视线没走。" }
      ]
    },
    {
      id: "ev_tension_03",
      type: "dailyEvent",
      category: "高张力互动",
      title: "训练房的对练",
      text: "对练时他突然压近，你们的距离只剩半步。",
      choices: [
        { label: "反手扣住", effects: { chemistry: 2, stamina: -1 }, log: "他低声说：有点意思。" },
        { label: "示意暂停", effects: { trust: 1, chemistry: 1 }, log: "他收手，但眼神还没散。" }
      ]
    },
    {
      id: "ev_tension_04",
      type: "dailyEvent",
      category: "高张力互动",
      title: "装备间的护短",
      text: "有人在装备间质疑你，他当场挡在你面前。",
      choices: [
        { label: "站到他身侧", effects: { trust: 2, chemistry: 1 }, log: "他说话不重，却很护你。" },
        { label: "自己回应对方", effects: { chemistry: 2, trust: 1 }, log: "他看你的眼神像是在夸。" }
      ]
    },
    {
      id: "ev_tension_05",
      type: "dailyEvent",
      category: "高张力互动",
      title: "雨夜门口",
      text: "雨夜门口风大，他伸手拉住你的手腕。",
      choices: [
        { label: "没挣开", effects: { chemistry: 3 }, log: "他把你带回屋檐里。" },
        { label: "故意问他在担心什么", effects: { chemistry: 2, trust: 1 }, log: "他只说：你知道。" }
      ]
    },
    {
      id: "ev_tension_06",
      type: "dailyEvent",
      category: "高张力互动",
      title: "食堂座位",
      text: "你刚坐下，他把餐盘放到你对面。",
      choices: [
        { label: "抬眼说：你终于肯坐", effects: { chemistry: 2, trust: 1 }, log: "他笑，说别得寸进尺。" },
        { label: "安静吃饭", effects: { trust: 1, chemistry: -1 }, log: "他仍旧没走。" }
      ]
    },
    {
      id: "ev_tension_07",
      type: "dailyEvent",
      category: "高张力互动",
      title: "值班室换班",
      text: "你发现他的班被调走，他只说晚点解释。",
      choices: [
        { label: "追问他", effects: { chemistry: 2, trust: 1 }, log: "他靠近说：别担心我。" },
        { label: "点头放他走", effects: { trust: 2, chemistry: -1 }, log: "他走到门口又回头。" }
      ]
    },
    {
      id: "ev_tension_08",
      type: "dailyEvent",
      category: "高张力互动",
      title: "屋顶对峙",
      text: "屋顶只有你们两人，他问你为什么最近避开他。",
      choices: [
        { label: "说你只是累了", effects: { trust: 1, chemistry: 1 }, log: "他点头，但没退开。" },
        { label: "反问他是不是怕了", effects: { chemistry: 3 }, log: "他笑了声，说试试看。" }
      ]
    },
    {
      id: "ev_tension_09",
      type: "dailyEvent",
      category: "高张力互动",
      title: "医务室的眼神",
      text: "你替人换药时，他站在门口盯着你。",
      choices: [
        { label: "用眼神示意他进来", effects: { chemistry: 2, trust: 1 }, log: "他靠近，声音压得很低。" },
        { label: "把他赶出去", effects: { trust: 1, chemistry: -1 }, log: "他扬眉：你确定？" }
      ]
    },
    {
      id: "ev_tension_10",
      type: "dailyEvent",
      category: "高张力互动",
      title: "走廊护短",
      text: "有人说你太拼，他当场把话题带走。",
      choices: [
        { label: "朝他点头", effects: { trust: 2, chemistry: 1 }, log: "他没看别人，只看你。" },
        { label: "开玩笑拆他的台", effects: { chemistry: 2 }, log: "他靠近低声：回去再算。" }
      ]
    },
    {
      id: "ev_awkward_01",
      type: "dailyEvent",
      category: "小尴尬",
      title: "错拿的围巾",
      text: "你把他的围巾拿走，他发现后站在门口盯你。",
      choices: [
        { label: "直接还回去", effects: { trust: 1, chemistry: 1 }, log: "他接过时指尖擦到你。" },
        { label: "问他要不要换一条", effects: { chemistry: 2, items: { blanket: -1 } }, log: "他挑眉：你舍得？" }
      ]
    },
    {
      id: "ev_awkward_02",
      type: "dailyEvent",
      category: "小尴尬",
      title: "误会的零食",
      text: "你把零食放桌上，他以为是给他。",
      choices: [
        { label: "顺势递过去", effects: { trust: 1, chemistry: 1, items: { snack: -1 } }, log: "他接过，说记下了。" },
        { label: "说是你的储备", effects: { chemistry: -1, trust: 1 }, log: "他没走，但笑意淡了。" }
      ]
    },
    {
      id: "ev_awkward_03",
      type: "dailyEvent",
      category: "小尴尬",
      title: "对讲机串频",
      text: "对讲机里传来他喊你的小名，你们同时停顿。",
      choices: [
        { label: "反问他为什么这样叫", effects: { chemistry: 2 }, log: "他沉默半秒，说你不讨厌。" },
        { label: "假装没听见", effects: { trust: 1 }, log: "他随后补一句：没事。" }
      ]
    },
    {
      id: "ev_awkward_04",
      type: "dailyEvent",
      category: "小尴尬",
      title: "医务室的误会",
      text: "你给别人包扎，他误以为你受伤。",
      choices: [
        { label: "拉住他解释", effects: { trust: 2, chemistry: 1 }, log: "他松了一口气。" },
        { label: "让他自己看清", effects: { chemistry: 2 }, log: "他靠近看清后低声说：别吓我。" }
      ]
    },
    {
      id: "ev_awkward_05",
      type: "dailyEvent",
      category: "小尴尬",
      title: "训练房的贴纸",
      text: "你背后贴了训练房的贴纸，他盯了一会儿。",
      choices: [
        { label: "让他帮你撕", effects: { chemistry: 2 }, log: "他指尖擦过你后背。" },
        { label: "自己撕掉", effects: { trust: 1, chemistry: -1 }, log: "他收回手。" }
      ]
    },
    {
      id: "ev_awkward_06",
      type: "dailyEvent",
      category: "小尴尬",
      title: "值班室的靠枕",
      text: "你把靠枕推到他那边，他以为你让他坐近点。",
      choices: [
        { label: "解释说只是给他靠", effects: { trust: 1, chemistry: 1 }, log: "他点头，却没换位置。" },
        { label: "干脆不解释", effects: { chemistry: 2 }, log: "他靠过来，问你紧张什么。" }
      ]
    }
  ];

  const dailyMainScenes = [
    {
      id: "daily_01",
      type: "dailyMain",
      title: "值班室交接",
      text: "你核对值班记录，沈砚站在身后轻声问：今天顺吗？",
      choices: [
        { label: "说还行，顺便递给他清单", effects: { trust: 2 }, log: "他收下清单，说晚上补给。" },
        { label: "调侃他问得像查岗", effects: { chemistry: 2 }, log: "他压低声说：你敢躲我？" }
      ]
    },
    {
      id: "daily_02",
      type: "dailyMain",
      title: "走廊补货",
      text: "你抱着箱子走在走廊，箱子有点重。",
      choices: [
        { label: "示意他帮你拿", effects: { trust: 1, chemistry: 1, stamina: 1 }, log: "他接过箱子，说下次别逞强。" },
        { label: "自己扛着走", effects: { stamina: -1, chemistry: -1 }, log: "他皱眉，但没拦你。" }
      ]
    },
    {
      id: "daily_03",
      type: "dailyMain",
      title: "食堂排班",
      text: "你们一起看排班表，今天他本该去巡检。",
      choices: [
        { label: "问他要不要换班", effects: { trust: 2 }, log: "他看你一眼，说只有你能安排我。" },
        { label: "让他按表走", effects: { trust: 1, chemistry: -1 }, log: "他点头，但目光没离开你。" }
      ]
    },
    {
      id: "daily_04",
      type: "dailyMain",
      title: "训练房收拾",
      text: "训练房收拾得乱，你俩一起捡垫子。",
      choices: [
        { label: "开玩笑让他请喝水", effects: { chemistry: 2, items: { tea: 1 } }, log: "他真的去倒水。" },
        { label: "默契地配合", effects: { trust: 2 }, log: "你们像排练过一样。" }
      ]
    },
    {
      id: "daily_05",
      type: "dailyMain",
      title: "装备清点",
      text: "你对着清单找工具盒，他站在柜门边。",
      choices: [
        { label: "让他帮你找", effects: { trust: 1, chemistry: 1, items: { toolkit: 1 } }, log: "他从最上层拿下来，递给你。" },
        { label: "自己踮脚去够", effects: { stamina: -1, chemistry: 1 }, log: "他伸手托了你一下。" }
      ]
    },
    {
      id: "daily_06",
      type: "dailyMain",
      title: "医务室回访",
      text: "你们一起回访值班室的轻伤员。",
      choices: [
        { label: "让他记录", effects: { trust: 1 }, log: "他记得很认真。" },
        { label: "让他帮你拿药", effects: { chemistry: 1, trust: 1 }, log: "他低声说你别走太远。" }
      ]
    },
    {
      id: "daily_07",
      type: "dailyMain",
      title: "屋顶透气",
      text: "你们站在屋顶透气，他先开口说：别总憋着。",
      choices: [
        { label: "承认最近有点累", effects: { trust: 2, stamina: 1 }, log: "他沉默一下，说今晚早点睡。" },
        { label: "说你挺习惯", effects: { chemistry: 2 }, log: "他盯你一会儿，说你太倔。" }
      ]
    },
    {
      id: "daily_08",
      type: "dailyMain",
      title: "雨天巡门",
      text: "雨天门口积水，他站在你身侧盯着外面。",
      choices: [
        { label: "与他站同一侧", effects: { chemistry: 2, trust: 1 }, log: "他侧过身，替你挡风。" },
        { label: "让他回去休息", effects: { trust: 2, chemistry: -1 }, log: "他没动，只说再等一会儿。" }
      ]
    },
    {
      id: "daily_09",
      type: "dailyMain",
      title: "值班室夜聊",
      text: "夜里你们一起整理记录，他忽然问你想不想换个岗位。",
      choices: [
        { label: "说现在挺好", effects: { trust: 2 }, log: "他说：那我就放心。" },
        { label: "问他会不会跟着换", effects: { chemistry: 2, trust: 1 }, log: "他轻笑，说你想得美。" }
      ],
      requires: (s) => s.day >= 2
    },
    {
      id: "daily_10",
      type: "dailyMain",
      title: "走廊拐角",
      text: "你刚转弯，他停在角落等你。",
      choices: [
        { label: "问他是不是在等你", effects: { chemistry: 2 }, log: "他不否认。" },
        { label: "绕过他继续走", effects: { chemistry: -1, trust: 1 }, log: "他跟在你后面。" }
      ]
    },
    {
      id: "daily_11",
      type: "dailyMain",
      title: "食堂打包",
      text: "食堂临时打包，他帮你拿了双份。",
      choices: [
        { label: "分他一份", effects: { trust: 1, chemistry: 1 }, log: "他接得很快。" },
        { label: "说你会饿", effects: { chemistry: 1 }, log: "他挑眉：你不怕我记账？" }
      ]
    },
    {
      id: "daily_12",
      type: "dailyMain",
      title: "训练房的默契",
      text: "你们一起把器械收起，他忽然把重的部分递给你。",
      choices: [
        { label: "接过并说没关系", effects: { trust: 2, stamina: -1 }, log: "他盯着你手臂说别硬撑。" },
        { label: "推回去让他拿", effects: { chemistry: 2 }, log: "他笑着接过，说你真会使唤人。" }
      ]
    },
    {
      id: "daily_13",
      type: "dailyMain",
      title: "装备间的贴纸",
      text: "你把注意事项贴在柜门，他站在旁边看。",
      choices: [
        { label: "让他写下一条提醒", effects: { trust: 2 }, log: "他的字很稳。" },
        { label: "问他要不要署名", effects: { chemistry: 2 }, log: "他说：只给你看。" }
      ]
    },
    {
      id: "daily_14",
      type: "dailyMain",
      title: "医务室门口",
      text: "他在医务室门口等你出来。",
      choices: [
        { label: "说你没事", effects: { trust: 1 }, log: "他点头，但没移开视线。" },
        { label: "反问他是不是担心", effects: { chemistry: 2 }, log: "他答得很轻：嗯。" }
      ]
    },
    {
      id: "daily_15",
      type: "dailyMain",
      title: "屋顶的风声",
      text: "屋顶风声太大，你们靠得更近说话。",
      choices: [
        { label: "说你听不清", effects: { chemistry: 2 }, log: "他靠近再说一遍。" },
        { label: "示意他别太靠", effects: { chemistry: -1, trust: 1 }, log: "他抬手挡住你的耳朵。" }
      ],
      requires: (s) => s.day >= 3
    },
    {
      id: "daily_16",
      type: "dailyMain",
      title: "值班室点名",
      text: "他点名你替他跑一趟，你挑眉看他。",
      choices: [
        { label: "答应但要交换条件", effects: { chemistry: 2, trust: 1 }, log: "他笑说你会谈判。" },
        { label: "直接拒绝", effects: { trust: -1, chemistry: 1 }, log: "他耸肩，说那就算了。" }
      ],
      requires: (s) => s.trust >= 6
    },
    {
      id: "daily_17",
      type: "dailyMain",
      title: "训练房的手套",
      text: "你手套被他拿走，他晃了晃让你来拿。",
      choices: [
        { label: "伸手抢回来", effects: { chemistry: 2, stamina: -1 }, log: "他抓住你的手腕。" },
        { label: "等他自己递还", effects: { trust: 1, chemistry: 1 }, log: "他笑着递给你。" }
      ]
    },
    {
      id: "daily_18",
      type: "dailyMain",
      title: "食堂夜点",
      text: "食堂夜点只剩一份，他问你要不要吃。",
      choices: [
        { label: "分他一半", effects: { trust: 1, chemistry: 1, items: { snack: -1 } }, log: "你们一起坐在角落。" },
        { label: "让他吃完", effects: { trust: 2, chemistry: -1 }, log: "他说你太客气。" }
      ],
      requires: (s) => s.items.snack > 0
    }
  ];

  const turbulenceScenes = [
    {
      id: "turb_01",
      type: "turbulence",
      title: "走廊停电",
      text: "走廊突然停电，你们只能靠手电前进。",
      choices: [
        { label: "牵住他的袖子", effects: { chemistry: 2, trust: 1 }, log: "他没说话，却放慢脚步。" },
        { label: "让他走前面", effects: { trust: 1 }, log: "他回头提醒你别掉队。" }
      ]
    },
    {
      id: "turb_02",
      type: "turbulence",
      title: "临时换班",
      text: "临时换班打乱计划，他把名单递给你。",
      choices: [
        { label: "帮他分担", effects: { trust: 2, stamina: -1 }, log: "他低声说欠你一次。" },
        { label: "让他自己处理", effects: { trust: -1, chemistry: 1 }, log: "他看你一眼，什么也没说。" }
      ]
    },
    {
      id: "turb_03",
      type: "turbulence",
      title: "装备失灵",
      text: "对讲机突然失灵，你们一起排查线路。",
      choices: [
        { label: "让他动手，你做记录", effects: { trust: 1, chemistry: 1, items: { toolkit: -1 } }, requires: (s) => s.items.toolkit > 0, log: "他一边修一边叮嘱你。" },
        { label: "两人一起钻进桌底", effects: { chemistry: 2, stamina: -1 }, log: "你们头碰头，谁也不先退。" }
      ]
    },
    {
      id: "turb_04",
      type: "turbulence",
      title: "雨夜门口",
      text: "雨夜门口多了陌生人，你们对视一眼。",
      choices: [
        { label: "让他出面", effects: { trust: 1, chemistry: 1 }, log: "他挡在你前面。" },
        { label: "你先开口", effects: { chemistry: 2, trust: 1 }, log: "他在你身后补一句。" }
      ]
    },
    {
      id: "turb_05",
      type: "turbulence",
      title: "医务室临诊",
      text: "医务室突然忙起来，他站在门口等指示。",
      choices: [
        { label: "让他递工具", effects: { trust: 2 }, log: "他动作稳得像熟手。" },
        { label: "让他出去安抚外面", effects: { trust: 1, chemistry: 1 }, log: "他临走前看了你一眼。" }
      ]
    },
    {
      id: "turb_06",
      type: "turbulence",
      title: "走廊堵塞",
      text: "走廊被箱子堵住，你们一起搬开。",
      choices: [
        { label: "让他先过", effects: { trust: 1, chemistry: 1 }, log: "他回身拉你一下。" },
        { label: "顶着箱子前进", effects: { stamina: -1, chemistry: 2 }, log: "他笑着说你真拼。" }
      ]
    },
    {
      id: "turb_07",
      type: "turbulence",
      title: "走廊误报",
      text: "警报误报响起，他第一时间找你。",
      choices: [
        { label: "让他放心", effects: { trust: 2, chemistry: 1 }, log: "他松了口气。" },
        { label: "问他是不是担心你", effects: { chemistry: 2 }, log: "他停顿，说是。" }
      ],
      requires: (s) => s.trust >= 5
    },
    {
      id: "turb_08",
      type: "turbulence",
      title: "屋顶冷风",
      text: "屋顶突然降温，他把外套扔给你。",
      choices: [
        { label: "穿上再还", effects: { chemistry: 2, trust: 1 }, log: "他看你扣好扣子。" },
        { label: "推回去", effects: { chemistry: -1, trust: 1 }, log: "他皱眉：别逞强。" }
      ]
    },
    {
      id: "turb_09",
      type: "turbulence",
      title: "设备故障",
      text: "设备故障需要门卡进入，他看着你。",
      choices: [
        { label: "拿出门卡", effects: { trust: 1, chemistry: 1, items: { keycard: -1 } }, requires: (s) => s.items.keycard > 0, log: "他低声说谢谢。" },
        { label: "让他去找人", effects: { trust: -1, chemistry: 1 }, log: "他点头，但明显不爽。" }
      ]
    },
    {
      id: "turb_10",
      type: "turbulence",
      title: "训练房突发",
      text: "训练房有人争执，他站在你前面压住场面。",
      choices: [
        { label: "在他身侧补一句", effects: { trust: 1, chemistry: 1 }, log: "场面很快平下来。" },
        { label: "示意他别太凶", effects: { chemistry: 2 }, log: "他靠近低声说：只对他们凶。" }
      ]
    },
    {
      id: "turb_11",
      type: "turbulence",
      title: "食堂临时断供",
      text: "食堂断供，你翻到一包零食。",
      choices: [
        { label: "分给他", effects: { trust: 1, chemistry: 1, items: { snack: -1 } }, requires: (s) => s.items.snack > 0, log: "他接过时说记你人情。" },
        { label: "说你也饿", effects: { chemistry: 1, trust: 1 }, log: "他笑：我知道。" }
      ]
    },
    {
      id: "turb_12",
      type: "turbulence",
      title: "门口检查",
      text: "门口临检，你们要对口供。",
      choices: [
        { label: "让他先说", effects: { trust: 1 }, log: "他很快把话接住。" },
        { label: "你先说，他补一句", effects: { chemistry: 2 }, log: "他的声音贴在你耳侧。" }
      ],
      requires: (s) => s.day >= 3
    }
  ];

  const endings = [
    {
      id: "end_bonded",
      type: "ending",
      title: "默契绑定",
      text: "你们不再多说什么，但每次对视都像确认过。",
      choices: [
        { label: "回到日常", next: "dayStart" }
      ],
      requires: (s) => s.trust >= 25 && s.chemistry >= 25
    },
    {
      id: "end_stable",
      type: "ending",
      title: "稳定陪伴",
      text: "你们保持距离却很稳定，他总能在你需要时出现。",
      choices: [
        { label: "回到日常", next: "dayStart" }
      ],
      requires: (s) => s.trust >= 25 && s.chemistry < 15
    },
    {
      id: "end_tension",
      type: "ending",
      title: "暧昧拉扯",
      text: "你们之间总有一句没说完的话，像风停在门口。",
      choices: [
        { label: "回到日常", next: "dayStart" }
      ],
      requires: (s) => s.trust < 18 && s.chemistry >= 25
    },
    {
      id: "end_companion",
      type: "ending",
      title: "并肩搭档",
      text: "你们的合作更像默契队友，话不多但很稳。",
      choices: [
        { label: "回到日常", next: "dayStart" }
      ],
      requires: (s) => s.trust >= 18 && s.chemistry >= 12
    },
    {
      id: "end_quiet",
      type: "ending",
      title: "安静余温",
      text: "你收起情绪，把日常过成缓慢的回音。",
      choices: [
        { label: "回到日常", next: "dayStart" }
      ],
      requires: (s) => s.trust < 18 && s.chemistry < 12
    },
    {
      id: "end_independent",
      type: "ending",
      title: "独自选择",
      text: "你把注意力放在自己身上，他没有打扰。",
      choices: [
        { label: "回到日常", next: "dayStart" }
      ],
      requires: (s) => s.stamina >= 20
    }
  ];

  const sceneMap = {};

  const baseScenes = [
    {
      id: "dayStart",
      type: "system",
      title: "日程开始",
      text: "你翻开新的任务卡，今天仍然是日常与一点点张力。",
      choices: [
        { label: "开始当天", after: startDayFlow }
      ]
    },
    {
      id: "hub",
      type: "hub",
      title: "日常主线枢纽",
      text: "你站在走廊交叉口，今天要做点什么？",
      choices: [
        { label: "进入日常主线", after: () => enterScene(pickFromPool(dailyMainScenes, "recentDailyMain").id) },
        { label: "处理小波澜", after: () => enterScene(pickFromPool(turbulenceScenes, "recentTurbulence").id) },
        { label: "进入下一天", after: endDay },
        { label: "收束关系", next: "ending_gate", requires: (s) => s.day >= 4 }
      ]
    },
    {
      id: "ending_gate",
      type: "system",
      title: "收束选择",
      text: "当你准备停下脚步，可以选择一种关系的落点。",
      choices: endings.map((end) => ({
        label: `查看结局：${end.title}`,
        next: end.id,
        requires: end.requires
      })).concat([
        { label: "还是再走几天", next: "hub" }
      ])
    }
  ];

  const scenePools = [...dailyMainScenes, ...turbulenceScenes, ...dailyEvents, ...endings, ...baseScenes];
  scenePools.forEach((scene) => {
    sceneMap[scene.id] = scene;
  });

  function wire(){
    el.btnNew.addEventListener("click", () => {
      state = defaultState();
      renderLog();
      addSys("新档已创建。欢迎回来。");
      enterScene("dayStart");
    });

    el.btnSave.addEventListener("click", () => {
      saveState();
      addSys("存档已保存到本地。");
      renderHUD();
    });

    el.btnReset.addEventListener("click", () => {
      window.localStorage.removeItem(SAVE_KEY);
      state = defaultState();
      renderLog();
      addSys("存档已清空。");
      enterScene("dayStart");
    });

    el.actDaily.addEventListener("click", () => {
      if (state.currentScene !== "hub"){
        addWarn("请回到主线枢纽再选择入口。");
        return;
      }
      enterScene(pickFromPool(dailyMainScenes, "recentDailyMain").id);
    });

    el.actTurbulence.addEventListener("click", () => {
      if (state.currentScene !== "hub"){
        addWarn("请回到主线枢纽再选择入口。");
        return;
      }
      enterScene(pickFromPool(turbulenceScenes, "recentTurbulence").id);
    });

    el.actNextDay.addEventListener("click", () => {
      if (state.currentScene !== "hub"){
        addWarn("请回到主线枢纽再进入下一天。");
        return;
      }
      endDay();
    });
  }

  let state = loadState() || defaultState();

  function boot(){
    if (!state.log.length){
      addSys("系统上线：任务卡 v0.3。");
      addSys("每日随机事件已启用。");
      addHint("提示：张力值越高，互动越有火花。");
    } else {
      renderLog();
    }
    wire();
    if (state.day >= 4){
      el.tipText.textContent = "第 4 天起可尝试收束关系（主线枢纽内）。";
    }
    if (!sceneMap[state.currentScene]){
      state.currentScene = "dayStart";
    }
    renderHUD();
    enterScene(state.currentScene || "dayStart");
  }

  boot();
})();
</script>
<script>
(function(){
  if (!("serviceWorker" in navigator)) return;
  window.addEventListener("load", function(){
    navigator.serviceWorker.register("./sw.js").catch(function(){});
  });
})();
</script>
</body>
</html>
